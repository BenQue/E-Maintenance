# 6. 史诗详情 (Epic Details)

## 史诗 1: 基础架构与核心报修流程

**目标**: 这个史诗的目标是搭建整个项目的技术地基，并交付一个完整的、最小化的核心产品闭环：一个用户可以注册登录，看到设备并成功提交一个维修请求。完成后，我们将拥有一个可以运行的、包含核心数据的系统骨架。

### 故事 1.1: 项目初始化与技术栈搭建

**作为一个** 开发人员,

**我想要** 一个配置好的 Monorepo 代码仓库，其中包含前端(Next.js)、后端(Node.js)和移动端(Flutter)的应用骨架,

**以便于** 我可以在一个一致和标准化的环境中开始功能开发。

**验收标准**:

- Monorepo 仓库已使用指定工具初始化。
- Web、API 和 Mobile 三个独立的应用/包已创建。
- 数据库(PostgreSQL)连接已通过 Prisma ORM 配置成功。
- 基础的 Linting 和格式化规则已配置。

### 故事 1.2: 用户认证与角色管理

**作为一个** 用户 (员工、技术员、主管),

**我想要** 能够注册和登录系统,

**以便于** 系统可以识别我的身份并授予我相应角色的访问权限。

**验收标准**:

- 提供用户注册和登录的 API 端点。
- 用户数据（包括加密后的密码）能被安全地存储在数据库中。
- 系统需包含至少三种角色：员工、技术员、主管。
- 登录成功后，系统返回一个用于身份验证的凭证 (Token)。

### 故事 1.3: 核心主数据管理 API

**作为一个** 系统管理员,

**我想要** 能够通过 API 对核心主数据（特别是设备清单）进行增、删、改、查操作,

**以便于** 为系统的正常运作提供必要的初始数据。

**验收标准**:

- 提供针对"设备/资产"资源的 CRUD (创建、读取、更新、删除) API 端点。
- API 端点受权限保护，只有特定角色（如主管）才能调用。
- 支持通过 API 进行设备主数据的批量导入。

### 故事 1.4: (移动端) 发起维修请求

**作为一个** 一线员工,

**我想要** 使用移动应用扫描设备码，填写一个包含位置、类别、图片和优先级的表单来提交维修请求,

**以便于** 我可以快速、准确、全面地报告设备故障。

**验收标准**:

- 用户可以在移动应用上成功登录。
- 应用可以通过摄像头扫描资产二维码，并调用 API 获取设备信息（包括其常规位置）自动填充表单。
- 用户必须选择一个具体的报修类别和报修原因（从预设列表中选择）。
- 用户可以手动输入或选择一个更精确的设备地点。
- 用户可以选填一段文字作为补充报修内容。
- 用户可以从相册选择或现场拍摄一张照片并附加到表单中，并支持在照片上进行简单的圈点标注。
- 用户可以为该维修请求选择一个预设的优先级（如：高、中、低）。
- 成功提交后，系统在数据库中创建一条新的工单记录，初始状态为"待处理"。

## 史诗 2: 工单管理与处理

**目标**: 这个史诗的核心目标是为维修技术员和主管提供一个完整的工单处理闭环。当这个史诗完成后，一个报修单从被创建开始，可以被顺利地指派、接收、处理、更新，直到最终完成归档，整个过程都在线上清晰可见。此外，系统将支持完整的跨平台照片管理功能，确保移动端采集的维修照片能够在PC端无缝查看和管理，为维修记录提供完整的可视化文档支持。

### 故事 2.1: 工单分配与通知

**作为一个** 设备部门主管,

**我想要** 系统能根据预设规则（如设备、区域、类别）自动分配新工单，并支持我手动调整,

**以便于** 提升派工效率，确保每个任务都有明确的负责人。

**验收标准**:

- 系统后台应提供一个简单的规则配置界面，用于设定自动派工的条件。
- 当新报修请求符合规则时，系统自动将其分配给指定的技术员。
- 被分配的技术员会收到新任务的通知。
- 主管可以在 Web 管理端手动将工单指派或改派给任何技术员。

### 故事 2.2: (Web/移动端) 工单处理与状态更新

**作为一个** 维修技术员,

**我想要** 在我的任务列表中查看工单，并能在执行过程中随时更新其状态,

**以便于** 高效管理我的工作，并让所有相关人员了解最新进展。

**验收标准**:

- 技术员登录后，可以在 Web 端和移动端看到一个"我的任务"列表。
- 技术员可以打开工单详情，查看所有报修信息、设备历史和附加文档。
- 技术员可以将工单状态从"待处理"更新为"进行中"或"等待备件"等。
- 工单状态的任何变更都会被记录，并对主管可见。

### 故事 2.3: (Web/移动端) 记录解决方案与完成工单

**作为一个** 维修技术员,

**我想要** 在维修完成后，方便地记录解决方案、填写故障代码并上传完成照片,

**以便于** 为设备建立完整的维护档案，并正式关闭工单。

**验收标准**:

- 在工单详情页，技术员可以将工单标记为"已完成"。
- 标记完成时，需要填写解决方案描述、选择故障代码（可选）。
- 技术员可以上传维修完成后的照片作为证明。
- 工单关闭后，所有相关信息会自动归档到对应资产的维护历史中。

### 故事 2.4: 工单状态跟踪与历史记录

**作为一个** 设备部门主管,

**我想要** 能够查看工单的完整状态变更历史和处理时间线,

**以便于** 监控处理效率并进行流程优化分析。

**验收标准**:

- 每个工单的状态变更都有完整的时间戳和操作人记录。
- 主管可以查看工单从创建到关闭的完整时间线。
- 系统能够生成工单处理时间的统计报告。
- 支持按时间段、技术员、设备类型等维度进行处理效率分析。

### 故事 2.5: 工单照片存储与跨平台显示

**作为一个** 维修技术员和设备主管,

**我想要** 移动端拍摄的工单照片能够安全存储到服务器，并且PC端能够查看和管理这些照片,

**以便于** 维修记录更加完整，跨平台协作更高效，照片资料便于长期存档和分析。

**验收标准**:

- 移动端用户能够在创建工单时上传设备故障照片到服务器。
- 移动端用户能够在工单完成时上传维修后的解决方案照片到服务器。
- PC端用户能够查看移动端上传的所有工单相关照片（故障照片和解决方案照片）。
- 照片存储系统按年月自动分类，支持缩略图生成和全尺寸查看。
- 照片访问具有适当的权限控制，只有相关工单的参与者才能查看照片。

## 史诗 3: KPI 仪表板与管理视图

**目标**: 这个史诗的目标是为管理者赋能。我们将利用前两个史诗积累的数据，构建一个强大的数据可视化和管理中心。完成后，主管不仅能宏观掌握维护工作的整体态势，还能对用户和设备等主数据进行日常管理。

### 故事 3.1: KPI 仪表板数据可视化

**作为一个** 设备部门主管,

**我想要** 在 Web 应用首页看到一个清晰、可视化的 KPI 仪表板,

**以便于** 我可以快速理解当前的工作负载、团队效率和整体资产健康状况。

**验收标准**:

- Web 应用的主管视图首页即为 KPI 仪表板。
- 仪表板必须包含"工单指标"模块，例如使用饼图展示不同状态的工单分布。
- 仪表板必须包含"时间指标"模块，展示关键指标如 MTTR。
- 仪表板必须包含"资产中心指标"模块，例如展示总停机时间最长的前 5 个设备。
- 仪表板上的所有数据需接近实时更新。

### 故事 3.2: 工单列表的高级筛选与查询

**作为一个** 设备部门主管,

**我想要** 能够通过多种条件（如状态、负责人、设备、日期范围）来筛选和搜索所有的工单,

**以便于** 我可以进行深入的分析和问题追溯。

**验收标准**:

- 提供一个工单管理页面，以列表形式展示所有工单。
- 列表上方提供搜索框和多个筛选条件。
- 筛选结果可以被导出为 CSV 文件。

### 故事 3.3: (Web) 用户与设备主数据管理

**作为一个** 设备部门主管,

**我想要** 一个简单的 Web 界面来管理用户和设备主数据,

**以便于** 我可以进行日常的人员调配和设备信息更新。

**验收标准**:

- 系统提供一个"用户管理"页面，主管可以对用户进行 CRUD 及角色分配。
- 系统提供一个"设备管理"页面，主管可以对设备资产进行 CRUD。
- 所有管理操作都受权限保护，仅主管及以上角色可访问。

## 史诗 4: Web 端用户登录界面

**目标**: 这个史诗的目标是为 Web 应用实现完整的用户登录和认证流程。虽然后端认证 API 已在史诗 1 中实现，但 Web 端仍缺少登录界面。完成后，用户将能够通过 Web 界面安全登录系统，根据其角色访问相应功能。

### 故事 4.1: 登录页面实现

**作为一个** 系统用户（员工、技术员、主管、管理员）,

**我想要** 通过一个专门的登录页面输入我的凭证进行身份验证,

**以便于** 我可以安全地访问系统并使用与我角色相关的功能。

**验收标准**:

- 创建 `/login` 路由和登录页面组件。
- 页面包含邮箱/用户名和密码输入框，使用 ShadCN/UI 组件。
- 实现表单验证，确保必填字段不为空。
- 登录按钮在请求期间显示加载状态。
- 登录失败时显示清晰的错误消息（如"用户名或密码错误"）。
- 登录成功后自动跳转到 dashboard 页面。

### 故事 4.2: 认证流程集成

**作为一个** 前端开发人员,

**我想要** 实现一个完整的认证流程，包括 token 管理和状态维护,

**以便于** 系统能够安全地处理用户会话并在后续请求中自动附加认证信息。

**验收标准**:

- 创建 `auth-service.ts` 服务，封装对后端 `/api/auth/login` 端点的调用。
- 创建 `auth-store.ts` 使用 Zustand 管理用户认证状态。
- JWT token 安全存储在 localStorage 中（后续可升级为 httpOnly cookies）。
- API 客户端自动在请求头中附加 Bearer token。
- 实现 token 过期检测和自动清理机制。
- 提供登出功能，清理 token 和用户状态。

### 故事 4.3: 路由保护和用户界面集成

**作为一个** 系统用户,

**我想要** 系统能够根据我的登录状态自动控制页面访问权限,

**以便于** 未登录用户无法访问受保护的页面，同时我能够看到自己的登录状态。

**验收标准**:

- 创建认证检查的布局组件，保护 `/dashboard` 路由。
- 未登录用户访问受保护页面时自动重定向到 `/login`。
- 登录后根据用户角色重定向到相应页面：
  - EMPLOYEE: `/dashboard/work-orders`
  - TECHNICIAN: `/dashboard/my-tasks`
  - SUPERVISOR/ADMIN: `/dashboard`
- 在导航栏显示当前登录用户的名称和角色。
- 导航栏包含"退出登录"按钮，点击后清理认证状态并返回登录页。
- 页面刷新后保持登录状态（读取存储的 token）。
