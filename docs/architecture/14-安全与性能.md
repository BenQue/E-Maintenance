# 14. 安全与性能

定义了 HTTPS、网络隔离、输入验证、代码分割、数据库索引和缓存等一系列安全与性能优化策略。

## 14.1 API 速率限制策略

### 14.1.1 分层速率限制架构

为了平衡用户体验和系统安全，采用分层速率限制策略：

#### 查看操作速率限制（宽松策略）
- **开发环境**: 10,000 次请求 / 15分钟
- **生产环境**: 1,000 次请求 / 15分钟
- **适用场景**: 所有 GET 请求（查看工单、获取照片、统计数据等）
- **设计理念**: 用户需要频繁查看工单信息，不应受到严格限制

#### 创建/修改操作速率限制（严格策略）
- **开发环境**: 200 次请求 / 15分钟
- **生产环境**: 50 次请求 / 15分钟
- **适用场景**: POST/PUT/DELETE 请求（创建、更新、删除、文件上传等）
- **设计理念**: 防止恶意批量操作和系统滥用

### 14.1.2 实施细节

#### Work Order Service 速率限制配置
```javascript
// 通用限制器（查看操作）
const generalLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15分钟
  max: isDevelopment ? 10000 : 1000,
  message: { error: 'Too many requests, please try again later.' }
});

// 严格限制器（写操作）
const strictLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15分钟
  max: isDevelopment ? 200 : 50,
  message: { error: 'Too many create/update requests, please try again later.' }
});
```

#### 应用范围

**宽松限制的端点**:
- `GET /api/work-orders/` - 工单列表
- `GET /api/work-orders/:id` - 工单详情
- `GET /api/work-orders/:id/work-order-photos` - 照片列表
- `GET /api/work-orders/statistics` - 统计数据
- `GET /api/work-orders/filter-options` - 筛选选项

**严格限制的端点**:
- `POST /api/work-orders/` - 创建工单
- `PUT /api/work-orders/:id` - 更新工单
- `PUT /api/work-orders/:id/status` - 更新状态
- `POST /api/work-orders/:id/attachments` - 上传文件
- `PUT /api/work-orders/:id/assign` - 分配工单
- `POST /api/work-orders/:id/complete` - 完成工单
- `POST /api/work-orders/:id/work-order-photos` - 上传照片

### 14.1.3 监控和响应

#### 速率限制响应头
```http
RateLimit-Limit: 1000
RateLimit-Remaining: 999
RateLimit-Reset: 1234567890
```

#### 429 错误响应格式
```json
{
  "error": "Too many create/update requests from this IP, please try again later.",
  "retryAfter": 900
}
```

### 14.1.4 优势和考虑

#### 优势
1. **用户体验优化**: 查看操作不受严格限制，用户可以自由浏览
2. **安全防护**: 防止恶意批量创建工单或频繁修改操作
3. **系统稳定**: 保护写操作资源，避免数据库过载
4. **灵活配置**: 开发和生产环境有不同的限制策略

#### 注意事项
- 基于 IP 地址限制，企业内网环境需要考虑 NAT 场景
- 可根据实际使用情况调整限制值
- 建议配合监控系统跟踪速率限制触发情况
